<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SkyWings - Manage Flights</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="../../css/styles.css">
	<script src="../../js/jquery.js"></script>
	<script src="/Flight-Booking-V2/Front-end/js/session-guard.js"></script>
	<script src="../../js/scripts.js"></script>
</head>
<body>
	<div class="container flex">
		<div class="sidebar">
			<div class="sidebar-brand">
				<div class="logo flex items-center gap-sm">
					<i class="fas fa-plane navbar-logo"></i>
					<h1>SkyWings</h1>
				</div>
			</div>

			<div class="sidebar-menu">
				<a href="../companyDashboard.html" class="sidebar-item" data-page="dashboard">
					<i class="fas fa-home sidebar-icon"></i>
					<span>Dashboard</span>
				</a>
				<a href="addFlight.html" class="sidebar-item" data-page="add-flight">
					<i class="fas fa-plane-departure sidebar-icon"></i>
					<span>Add Flight</span>
				</a>
				<a href="manageFlgihts.html" class="sidebar-item" data-page="manage-flights">
					<i class="fas fa-list sidebar-icon"></i>
					<span>Manage Flights</span>
				</a>
				<a href="bookings.html" class="sidebar-item" data-page="bookings">
					<i class="fas fa-users sidebar-icon"></i>
					<span>Bookings</span>
				</a>
				<a href="companyProfile.html" class="sidebar-item" data-page="profile">
					<i class="fas fa-id-card sidebar-icon"></i>
					<span>Profile</span>
				</a>
				<a href="analytics.html" class="sidebar-item" data-page="analytics">
					<i class="fas fa-chart-bar sidebar-icon"></i>
					<span>Analytics</span>
				</a>
				<a href="companyMessages.html" class="sidebar-item" data-page="messages">
					<i class="fas fa-envelope sidebar-icon"></i>
					<span>Messages</span>
				</a>
				<a href="../companyDashboard.html#settings" class="sidebar-item" data-page="settings">
					<i class="fas fa-cog sidebar-icon"></i>
					<span>Settings</span>
				</a>
			</div>

			<div class="user-profile mt-auto p-lg">
				<div class="user-info flex items-center">
					<div class="user-avatar" id="company-avatar-initials" style="overflow: hidden;">
						<img id="company-avatar-logo" src="" alt="" style="display: none; width: 100%; height: 100%; object-fit: cover;">
						<span id="company-avatar-text">--</span>
					</div>
					<div class="user-details">
						<h4 class="text-md font-semibold" id="companyName">—</h4>
						<p class="text-sm text-secondary" id="companyRole">—</p>
					</div>
				</div>
			</div>
		</div>

		<div class="main-content">
			<div class="page-header mb-xl">
				<div class="header flex justify-between items-center mb-lg">
					<div>
						<h2 class="page-title">Manage Flights</h2>
						<p class="page-subtitle">Track schedules, capacity, and operational status</p>
					</div>
					<div class="header-actions flex items-center gap-md">
						<a class="btn btn-primary" href="addFlight.html"><i class="fas fa-plus"></i> Add Flight</a>
					</div>
				</div>
			</div>

			<div class="card mb-lg">
				<div class="card-body">
					<div class="grid grid-cols-2 gap-lg">
						<div class="form-group">
							<label class="form-label" for="flight-search">Search flights</label>
							<input class="form-control" id="flight-search" type="text" placeholder="Search by code, origin, or destination">
						</div>
						<div class="form-group">
							<label class="form-label" for="filter-status">Status</label>
							<select class="form-control" id="filter-status">
								<option value="all" selected>All statuses</option>
								<option value="scheduled">Scheduled</option>
								<option value="on-time">On Time</option>
								<option value="delayed">Delayed</option>
								<option value="cancelled">Cancelled</option>
							</select>
						</div>
					</div>
				</div>
			</div>

			<div class="card">
				<div class="card-header flex justify-between items-center">
					<h3 class="card-title">Active Flight Roster</h3>
					<span class="text-sm text-secondary" id="flight-count">0 flights</span>
				</div>
				<div class="card-body">
					<div class="table-container">
						<table class="table">
							<thead>
								<tr>
									<th>Flight</th>
									<th>Route</th>
									<th>Departure</th>
									<th>Seats</th>
									<th>Status</th>
									<th class="text-right">Actions</th>
								</tr>
							</thead>
							<tbody id="manage-flights-body"></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		$(function() {
			SkyWingsUI.initNavigation('manage-flights');

			// Load company profile for sidebar
			$.ajax({
				url: '../../../Back-End/company/dashboard-company.php',
				method: 'GET',
				dataType: 'json',
				success: function(resp) {
					if (resp?.success && resp.data?.company) {
						const c = resp.data.company;
						const logo = c.logo || null;
						
						if (logo) {
							const logoPath = logo.startsWith('http') ? logo : `../../../Back-End/${logo}`;
							$('#company-avatar-logo').attr('src', logoPath).show();
							$('#company-avatar-text').hide();
						} else {
							$('#company-avatar-logo').hide();
							$('#company-avatar-text').text(c.avatarInitials || 'CO').show();
						}
						
						$('#companyName').text(c.name || 'Company');
						$('#companyRole').text('Flight Operations');
					}
				}
			});

			let flights = [];

			function badgeForStatus(status) {
				switch (status) {
					case 'on-time':
					case 'scheduled': return '<span class="badge badge-primary">Scheduled</span>';
					case 'delayed': return '<span class="badge badge-warning">Delayed</span>';
					case 'cancelled': return '<span class="badge badge-error">Cancelled</span>';
					default: return '<span class="badge badge-success">Active</span>';
				}
			}

			function renderFlights(list) {
				const body = $('#manage-flights-body');
				body.empty();
				list.forEach(function(f) {
					const row = `
						<tr data-id="${f.id || ''}">
							<td class="font-semibold">${f.flight_code || f.code}</td>
							<td>${f.route || f.name || '-'}</td>
							<td>${f.departure || '-'}</td>
							<td>${f.seats ?? '-'}</td>
							<td>${badgeForStatus(f.status)}</td>
							<td class="text-right">
								<a class="btn btn-outline btn-sm" data-id="${f.id || ''}" href="viewFlight.html?flight=${f.id || ''}"><i class="fas fa-eye"></i> View</a>
								<button class="btn btn-outline-secondary btn-sm btn-disable-flight" data-id="${f.id || ''}"><i class="fas fa-power-off"></i> Cancel</button>
							</td>
						</tr>`;
					body.append(row);
				});
				$('#flight-count').text(`${list.length} flights`);
			}

			function applyFilters() {
				const query = $('#flight-search').val().toLowerCase();
				const status = $('#filter-status').val();

				const filtered = flights.filter(function(f) {
					const matchesQuery = !query || (f.flight_code || '').toLowerCase().includes(query) || (f.route || '').toLowerCase().includes(query) || (f.name || '').toLowerCase().includes(query);
					const matchesStatus = status === 'all' || f.status === status;
					return matchesQuery && matchesStatus;
				});

				renderFlights(filtered);
			}

			function fetchFlightDetails(id) {
				return $.ajax({
					url: '../../../Back-End/company/flight_details.php',
					method: 'GET',
					data: { flight_id: id },
					dataType: 'json'
				});
			}

			function showFlightDetails(data) {
				const f = data?.flight || {};
				const itinerary = (data?.itinerary || []).map(i => i.city_name).join(' → ');
				const message = [
					`Flight: ${f.flight_code || '-'}`,
					`Name/Route: ${f.name || '-'}`,
					`Departure: ${f.start_datetime || '-'}`,
					`Arrival: ${f.end_datetime || '-'}`,
					`Seats: ${f.max_passengers ?? '-'}`,
					`Fee: ${f.fees ?? '-'}`,
					`Status: ${f.is_completed ? 'Completed/Cancelled' : 'Scheduled/Active'}`,
					`Itinerary: ${itinerary || 'n/a'}`
				].join('\n');
				alert(message);
			}

			function loadFlights() {
				$('#flight-count').text('Loading...');
				$.ajax({
					url: '../../../Back-End/company/home.php',
					method: 'GET',
					dataType: 'json',
					success: function(resp) {
						if (!resp?.success) {
							$('#flight-count').text('0 flights');
							return;
						}
						const baseFlights = resp.data?.flights || [];
						const detailPromises = baseFlights.map(function(f) {
							return fetchFlightDetails(f.id).then(function(d) {
								return { base: f, detail: d?.data?.flight, itinerary: d?.data?.itinerary };
							}).catch(function() {
								return { base: f };
							});
						});

						Promise.all(detailPromises).then(function(items) {
							flights = items.map(function(item) {
								const b = item.base || {};
								const d = item.detail || {};
								const status = d.is_completed ? 'cancelled' : 'scheduled';
								return {
									id: b.id,
									flight_code: b.flight_code,
									route: d.name || b.name || b.flight_code,
									departure: d.start_datetime || '-',
									seats: d.max_passengers ?? '-',
									status: status
								};
							});
							applyFilters();
						});
					}
				});
			}

			$('#flight-search').on('input', applyFilters);
			$('#filter-status').on('change', applyFilters);

			$(document).on('click', '.btn-disable-flight', function() {
				const id = $(this).data('id');
				if (!id) return;
				if (!confirm('Cancel this flight and refund registered passengers?')) return;
				$.ajax({
					url: '../../../Back-End/company/cancel_flight.php',
					method: 'POST',
					data: { flight_id: id },
					dataType: 'json',
					success: function(resp) {
						if (resp?.success) {
							loadFlights();
						} else {
							console.error('Flight cancellation failed:', resp?.message);
						}
					},
					error: function(xhr) {
						console.error('Network error cancelling flight:', xhr.responseText);
					}
				});
			});

			loadFlights();
		});
	</script>
</body>
</html>
